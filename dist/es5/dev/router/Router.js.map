{"version":3,"sources":["../../../es6/dev/router/Router.js"],"names":["root","factory","define","amd","exports","module","require","MatchBinder","utils","Router","location","undefined","_location","replace","getBinder","_listeners","Set","_handlers","loc","RegExp","test","currLocation","trigger","started","parts","split","segments","getLocation","query","setQuery","params","execute","then","setRoutes","move","setLocation","Promise","resolve","matched","binder","active","checkStatus","length","forEach","item","handler","applied","triggered","filter","disable","triggerRoutes","listener","listeners","add","remove","delete","handlers","prevLocation","mapHandler","match","bind"],"mappings":"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","file":"Router.js","sourcesContent":["/*globals define*/\n(function(root, factory) {\n\n    if (typeof define === 'function' && define.amd) {\n        // AMD. Register as an anonymous module.\n        define([\n            './MatchBinder',\n            './utils'\n        ], factory);\n    } else if (typeof exports === 'object') {\n        // Node. Does not work with strict CommonJS, but\n        // only CommonJS-like environments that support module.exports,\n        // like Node.\n        module.exports = factory(require('./MatchBinder'), require('./utils'));\n    }\n}(this, function(MatchBinder, utils) {\n        'use strict';\n\n        class Router {\n            constructor(location) {\n                if (location !== undefined && location !== '') {\n                    this._location = location.replace(/^\\/|\\/$/g, '') + '/';\n                }\n                this.root = this.getBinder();\n                this._listeners = new Set();\n                this._handlers = new Set();\n            };\n\n            getBinder() {\n                return new MatchBinder('', this);\n            };\n\n            test(loc) {\n                return new RegExp('^' + this._location, 'g').test(loc);\n            }\n\n            getLocation(loc) {\n                let location = loc.replace(/^\\/|$/g, '');\n                if (this._location !== undefined) {\n                    if (this.test(location)) {\n                        return location.replace(this._location, '');\n                    } else {\n                        return false;\n                    }\n                }\n                return location;\n            };\n\n            reTrigger() {\n                if (this.currLocation) {\n                    this.trigger(this.currLocation);\n                }\n            };\n\n\n            trigger(location) {\n                if (this.started) {\n                    // this.started = false;\n                    this.currLocation = location;\n                    let parts = location.split('?', 2),\n                        segments = this.getLocation(parts[0]);\n                    if (segments || segments === '') {\n                        let query = utils.setQuery(parts[1]),\n                            params = {\n                                root:  segments,\n                                query: query\n                            };\n                        this.execute(segments, params)\n                            .then(move=>this.setRoutes(move, segments, params))\n                            .then(move=> this.setLocation(move));\n                    }\n                }\n            };\n\n            execute(location, params) {\n                return new Promise((resolve)=> {\n                    let matched = location.replace(/^\\/|$/g, '').split('/'),\n                        binder = this.root,\n                        active = binder.checkStatus(matched, params);\n                    if (active.length > 0) {\n                        active.forEach((item)=> {\n                            item.handler.then((applied)=> {\n                                if (!item.triggered) {\n                                    item.triggered = true;\n                                    item.applied = applied;\n                                    if (active.filter(item=>item.applied).length === active.length) {\n                                        active.forEach(item=>item.disable());\n                                        resolve(true);\n                                    } else if (active.filter(item=>item.triggered).length === active.length) {\n                                        resolve(false);\n                                    }\n                                }\n                            });\n                        });\n                    } else {\n                        resolve(true);\n                    }\n                });\n            };\n\n            setRoutes(move, location, params) {\n                if (move) {\n                    this._handlers.forEach(handler=>handler());\n                    this.root.triggerRoutes(location, params);\n                }\n                return move;\n            };\n\n            setListener(listener) {\n                let listeners = this._listeners;\n                listeners.add(listener);\n                return {\n                    remove(){\n                        listeners.delete(listener);\n                    }\n                }\n            };\n\n            onRouteChange(handler) {\n                let handlers = this._handlers;\n                handlers.add(handler);\n                return {\n                    remove(){\n                        handlers.delete(handler);\n                    }\n                }\n            };\n\n\n            setLocation(move) {\n                let location = move ? this.currLocation : this.prevLocation;\n                this.prevLocation = location;\n                // this.started = true;\n                this._listeners.forEach(listener=>listener(location, move));\n            };\n\n            match(mapHandler) {\n                mapHandler(this.root.match.bind(this.root));\n            };\n\n            start() {\n                this.started = true;\n            };\n\n            stop() {\n                this.started = false;\n            };\n        }\n        return Router;\n    }\n));\n"]}