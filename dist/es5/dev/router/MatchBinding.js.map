{"version":3,"sources":["../../../es6/dev/router/MatchBinding.js"],"names":[],"mappings":"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","file":"MatchBinding.js","sourcesContent":["(function(root, factory) {\n\n    if (typeof define === 'function' && define.amd) {\n        // AMD. Register as an anonymous module.\n        define([\n            './utils'\n        ], factory);\n    } else if (typeof exports === 'object') {\n        // Node. Does not work with strict CommonJS, but\n        // only CommonJS-like environments that support module.exports,\n        // like Node.\n        module.exports = factory(require('./utils'));\n    }\n}(this, function(utils) {\n    'use strict';\n\n\n    class MatchBinding {\n        constructor(pattern, location, binder) {\n            if (binder) {\n                this._binder = binder;\n            }\n            if (location === '') {\n                this.pattern = pattern.replace(/^\\(\\/\\)/g, '').replace(/^\\/|$/g, '');\n            } else {\n                this.pattern = pattern;\n            }\n\n            let route = this.pattern.replace(MatchBinding.ESCAPE_PARAM, '\\\\$&')\n                .replace(MatchBinding.OPTIONAL_PARAM, '(?:$1)?')\n                .replace(MatchBinding.NAMED_PARAM, function(match, optional) {\n                    return optional ? match : '([^\\/]+)';\n                }).replace(MatchBinding.SPLAT_PARAM, '(.*?)');\n\n            this.patternRegExp = new RegExp('^' + route);\n\n            this.routeHandler = [];\n            this.leaveHandler = [];\n            this.queryHandler = [];\n            this.routes = [];\n            this._active = false;\n        }\n\n        onBind() {\n        };\n\n        setOnBind(onBinding) {\n            this.onBind = onBinding\n        };\n\n        rebind() {\n            if (this.onBind !== undefined) {\n                this.onBind();\n            }\n        };\n\n        setRoutes(routes) {\n            this.routes.push(routes);\n            return this;\n        };\n\n        getRoutes() {\n            return this.routes;\n        };\n\n        match(match) {\n            var subBinder = this.getSubBinder();\n            match(subBinder.match.bind(subBinder))\n            return this;\n        };\n\n        to(routeHandler) {\n            this.routeHandler.push({handler: routeHandler, done: false});\n            return this;\n        };\n\n        leave(leaveHandler) {\n            var args = utils.getArgs(leaveHandler);\n            this.leaveHandler.push({handler: leaveHandler, done: (args.length > 0 && args[0] === 'done')});\n            return this;\n        };\n\n        query(queryHandler) {\n            this.queryHandler.push({handler: queryHandler, done: false});\n            return this;\n        };\n\n        remove() {\n            this.routes.splice(0, this.routes.length);\n            this.routeHandler.splice(0, this.routeHandler.length);\n            this.leaveHandler.splice(0, this.leaveHandler.length);\n            this.queryHandler.splice(0, this.queryHandler.length);\n            return this;\n        };\n\n        test(location) {\n            return this.patternRegExp.test(location);\n        };\n\n        getFragment(location) {\n            let subLocation = this.applyParams(location);\n            return location.replace(subLocation, '');\n        };\n\n        applyParams(location) {\n            let matches = this.pattern.replace(/\\((.*?)\\)/g, '$1').split('/');\n            let matches2 = location.split('/');\n            return matches2.splice(0, matches.length).join('/');\n        };\n\n        extractParams(fragment) {\n            let params = this.patternRegExp.exec(fragment)\n            if (params && params.length > 0) {\n                return params.slice(1).map(function(param) {\n                    return param ? decodeURIComponent(param) : null;\n                });\n            } else {\n                return [];\n            }\n        };\n\n        setSubBinder(MatchBinder, pattern, mapHandler) {\n            let subBinder = new MatchBinder(pattern);\n            this.subBinder = subBinder;\n            if (typeof mapHandler === 'function') {\n                mapHandler(subBinder.match.bind(subBinder));\n            }\n            return subBinder;\n        };\n\n        getSubBinder() {\n            return this.subBinder;\n        };\n\n        getHandler() {\n            return this.routeHandler;\n        };\n\n        getLeaveHandler() {\n            return this.leaveHandler;\n        };\n\n        getQueryHandler() {\n            return this.queryHandler;\n        };\n\n        getHandlers(name) {\n            let map = {\n                to: 'getHandler', leave: 'getLeaveHandler', query: 'getQueryHandler'\n            }\n            return this[map[name]]();\n        };\n\n        checkSegment(matched, params) {\n            let status = [];\n            if (this._active) {\n                let pattern = this.pattern.replace(/\\((.*?)\\)/g, '$1').replace(/^\\//, '').split('/'),\n                    prevLoc = this.prevLoc.replace(/^\\//, '').split('/'),\n                    currSegment = matched.slice(0, pattern.length),\n                    prevSegment = prevLoc.slice(0, pattern.length),\n                    equals = (utils.equals(currSegment, prevSegment));\n\n                if (!equals) {\n                    status = this.clearActive(params);\n                } else if (matched.length > 1) {\n                    status = this.getSubBinder().checkStatus(matched.slice(pattern.length), params);\n                } else if (equals) {\n                    status = this.getSubBinder().clearActive(params);\n                }\n            }\n            return status;\n        }\n\n        clearActive(params) {\n            let active = [];\n            if (this._active) {\n                active.push(this.triggerLeave(params));\n                this._active = false;\n            }\n\n            return active.concat(this.getSubBinder().clearActive());\n        }\n\n        triggerTo(location, params) {\n            if (this.test(location)) {\n                if (!this._active) {\n                    this.trigger('to', params, location);\n                    this._active = true;\n                }\n                this.trigger('query', params, location);\n                let fragment = this.getFragment(location);\n                if (fragment.trim() !== '') {\n                    let subBinder = this.getSubBinder();\n                    if (subBinder && subBinder.bindings && subBinder.bindings.length > 0) {\n                        subBinder.trigger(fragment, params);\n                    }\n                }\n            }\n        };\n\n        triggerLeave(params) {\n            return (cb)=> {\n                let handlers = this.getLeaveHandler(),\n                    loc = utils.getLocation(params, this.prevLoc),\n                    items = 0,\n                    stopped = false;\n                handlers.forEach((item)=> {\n                    if (item.done) {\n                        items++;\n                    }\n                    let caller = (done = true)=> {\n                        if (done) {\n                            items--;\n                            if (items === 0 && !stopped) {\n                                cb(true);\n                            }\n                        } else if (!done && !stopped) {\n                            stopped = true;\n                        }\n                        if (stopped) {\n                            cb(false);\n                        }\n                    }\n                    item.handler(caller, loc);\n\n                });\n                if (items === 0) {\n                    cb(true);\n                }\n\n\n            }\n        }\n\n        trigger(name, params, location) {\n            if (name === 'to') {\n                this.prevLoc = location;\n            }\n            let args = this.extractParams(location).concat(utils.getLocation(params, location)),\n                handlers = this.getHandlers(name);\n            this.applyHandlers(handlers, args)\n        };\n\n        applyHandlers(handlers, args = []) {\n            if (handlers && handlers.length > 0) {\n                handlers.forEach((item)=> {\n                    item.handler.apply(this, args);\n                });\n            }\n        }\n    }\n\n    Object.assign(MatchBinding, {\n        OPTIONAL_PARAM: /\\((.*?)\\)/g,\n        NAMED_PARAM:    /(\\(\\?)?:\\w+/g,\n        SPLAT_PARAM:    /\\*\\w+/g,\n        ESCAPE_PARAM:   /[\\-{}\\[\\]+?.,\\\\\\^$|#\\s]/g\n    });\n\n    return MatchBinding;\n}));"]}