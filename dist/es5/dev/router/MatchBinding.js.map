{"version":3,"sources":["../../../es6/dev/router/MatchBinding.js"],"names":[],"mappings":"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","file":"MatchBinding.js","sourcesContent":["(function(root, factory) {\n\n    if (typeof define === 'function' && define.amd) {\n        // AMD. Register as an anonymous module.\n        define([\n            './utils'\n        ], factory);\n    } else if (typeof exports === 'object') {\n        // Node. Does not work with strict CommonJS, but\n        // only CommonJS-like environments that support module.exports,\n        // like Node.\n        module.exports = factory(require('./utils'));\n    }\n}(this, function(utils) {\n    'use strict';\n\n\n    class MatchBinding {\n        constructor(pattern, location, binder) {\n            if (binder) {\n                this.binder = binder;\n            }\n            if (location === '') {\n                this.pattern = pattern.replace(/^\\(\\/\\)/g, '').replace(/^\\/|$/g, '');\n            } else {\n                let match = pattern.match(/^(\\/|\\(\\/)/g);\n                if (match === null) {\n                    pattern = pattern[0] === '(' ? '(/' + pattern.substring(1) : '/' + pattern;\n                }\n                this.pattern = pattern;\n            }\n\n            let route = this.pattern.replace(MatchBinding.ESCAPE_PARAM, '\\\\$&')\n                .replace(MatchBinding.OPTIONAL_PARAM, '(?:$1)?')\n                .replace(MatchBinding.NAMED_PARAM, function(match, optional) {\n                    return optional ? match : '([^\\/]+)';\n                }).replace(MatchBinding.SPLAT_PARAM, '(.*)');\n\n            this.patternRegExp = new RegExp('^' + route);\n\n            this.routeHandler = new Set();\n            this.leaveHandler = new Set();\n            this.queryHandler = new Set();\n            this._active = false;\n        }\n\n        setRoutes(mapHandler) {\n            var subBinder = this.subBinder;\n            mapHandler({\n                match: subBinder.match.bind(subBinder)\n            });\n            return this;\n        };\n\n        reTrigger() {\n            this.binder.reTrigger();\n        }\n\n        match(match) {\n            var subBinder = this.subBinder;\n            match(subBinder.match.bind(subBinder));\n            return this;\n        };\n\n        to(routeHandler) {\n            this.routeHandler.add({handler: routeHandler, done: false});\n            this.reTrigger();\n            return this;\n        };\n\n        leave(leaveHandler) {\n            var args = utils.getArgs(leaveHandler);\n            this.leaveHandler.add({handler: leaveHandler, done: (args.length > 0 && args[0] === 'done')});\n            return this;\n        };\n\n        query(queryHandler) {\n            this.queryHandler.add({handler: queryHandler, done: false});\n            return this;\n        };\n\n        remove() {\n            this.routeHandler.clear();\n            this.leaveHandler.clear();\n            this.queryHandler.clear();\n            return this;\n        };\n\n        test(location) {\n            return this.patternRegExp.test(location);\n        };\n\n        getFragment(location) {\n            let matches = location.match(this.patternRegExp);\n            return matches === null ? '' : location.substring(matches[0].length);\n        };\n\n        extractParams(fragment) {\n            let params = this.patternRegExp.exec(fragment)\n            if (params && params.length > 0) {\n                return params.slice(1).map(function(param) {\n                    return param ? decodeURIComponent(param) : null;\n                });\n            } else {\n                return [];\n            }\n        };\n\n        setSubBinder(MatchBinder, pattern, mapHandler) {\n            let subBinder = new MatchBinder(pattern, this);\n            this.subBinder = subBinder;\n            if (typeof mapHandler === 'function') {\n                mapHandler(subBinder.match.bind(subBinder));\n            }\n            return subBinder;\n        };\n\n\n        checkSegment(matched, params) {\n            let status = [];\n            if (this._active) {\n                let pattern = this.pattern.replace(/\\((.*?)\\)/g, '$1').replace(/^\\//, '').split('/'),\n                    prevLoc = this.prevLoc.replace(/^\\//, '').split('/'),\n                    currSegment = matched.slice(0, pattern.length),\n                    prevSegment = prevLoc.slice(0, pattern.length),\n                    equals = (utils.equals(currSegment, prevSegment));\n\n                if (!equals) {\n                    status = this.clearActive(params);\n                } else if (matched.length > 1) {\n                    status = this.subBinder.checkStatus(matched.slice(pattern.length), params);\n                } else if (equals) {\n                    status = this.subBinder.clearActive(params);\n                }\n            }\n            return status;\n        }\n\n        clearActive(params) {\n            let active = [];\n            if (this._active) {\n                active.push(this.triggerLeave(params));\n                this._active = false;\n            }\n\n            return active.concat(this.subBinder.clearActive());\n        }\n\n        triggerTo(location, params) {\n            if (this.test(location)) {\n                if (!this._active) {\n                    this.trigger('to', params, location);\n                    this._active = true;\n                }\n                this.trigger('query', params, location);\n                let fragment = this.getFragment(location);\n                if (fragment.trim() !== '') {\n                    let subBinder = this.subBinder;\n                    if (subBinder) {\n                        subBinder.trigger(fragment, params);\n                    }\n                }\n            }\n        };\n\n        triggerLeave(params) {\n            return (cb)=> {\n                let handlers = this.leaveHandler,\n                    location = utils.getLocation(params, this.prevLoc),\n                    items = 0,\n                    stopped = false;\n                if (handlers && handlers.size > 0) {\n                    handlers.forEach((item)=> {\n                        if (item.done) {\n                            items++;\n                        }\n                        item.handler((done = true)=> {\n                            if (done) {\n                                items--;\n                                if (items === 0 && !stopped) {\n                                    cb(true);\n                                }\n                            } else if (!done && !stopped) {\n                                stopped = true;\n                            }\n                            if (stopped) {\n                                cb(false);\n                            }\n                        }, location);\n\n                    });\n                }\n                if (items === 0) {\n                    cb(true);\n                }\n            }\n        }\n\n        getHandlers(name) {\n            let map = {\n                to: 'routeHandler', leave: 'leaveHandler', query: 'queryHandler'\n            }\n            return this[map[name]];\n        };\n\n        trigger(name, params, location) {\n            if (name === 'to') {\n                this.prevLoc = location;\n            }\n\n            let args = this.extractParams(location).concat(utils.getLocation(params, location)),\n                handlers = this.getHandlers(name);\n            this.applyHandlers(handlers, args)\n        };\n\n        applyHandlers(handlers, args = []) {\n            if (handlers && handlers.size > 0) {\n                handlers.forEach((item)=> {\n                    item.handler.apply(this, args);\n                });\n            }\n        }\n    }\n\n    Object.assign(MatchBinding, {\n        OPTIONAL_PARAM: /\\((.*?)\\)/g,\n        NAMED_PARAM:    /(\\(\\?)?:\\w+/g,\n        SPLAT_PARAM:    /\\*\\w+/g,\n        ESCAPE_PARAM:   /[\\-{}\\[\\]+?.,\\\\\\^$|#\\s]/g\n    });\n\n    return MatchBinding;\n}));"]}